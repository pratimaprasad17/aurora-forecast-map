<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Aurora Forecast</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: white;
      color: #333;
    }
    #container {
      padding: 5px;
      max-width: 1500px;
      margin: auto;
    }
    #status {
      margin-bottom: 8px;
      font-size: 0.9rem;
      opacity: 0.85;
    }
    #map {
      width: 100%;
      height: 90vh;
    }
    #footer {
      margin-top: 10px;
      font-size: 0.85rem;
      color: #666;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="status">Loading latest aurora forecastâ€¦</div>
    <div id="map"></div>
    <div id="footer">
      Loaded latest data from NOAA when you opened this page.
      <span id="timer"></span>
    </div>
  </div>

  <script>
    const AURORA_URL = "https://services.swpc.noaa.gov/json/ovation_aurora_latest.json";

    async function loadAurora() {
      const statusEl = document.getElementById("status");
      const timerEl  = document.getElementById("timer");

      try {
        statusEl.textContent = "Fetching data from NOAAâ€¦";

        const resp = await fetch(AURORA_URL);
        if (!resp.ok) throw new Error("HTTP " + resp.status);

        const data = await resp.json();
        const coords = data.coordinates || [];

        // ðŸ”» Reduce dot density: keep every Nth point
        const step = 1; // try 3; increase to 4/5 if you want even fewer points
        const lons   = [];
        const lats   = [];
        const values = [];

        for (let i = 0; i < coords.length; i += step) {
          lons.push(coords[i][0]);
          lats.push(coords[i][1]);
          values.push(coords[i][2]);
        }

        const obsTime = data["Observation Time"] || "";
        const fcTime  = data["Forecast Time"] || "";

        const maxVal = Math.max(...values);

        // thresholds and colors (mirror the Python version)
        const thresholds = [0, 1, 5, 10];
        const thrColors = {
          0: "#808080",   // grey
          1: "#00cc96",   // green
          5: "#ffa15a",   // orange
          10: "#ef553b",  // red
        };

        // build one trace per threshold
        const traces = thresholds.map((thr, i) => {
          const idxs = values
            .map((v, j) => (v >= thr ? j : -1))
            .filter(j => j >= 0);

          const tLons   = idxs.map(j => lons[j]);
          const tLats   = idxs.map(j => lats[j]);
          const tValues = idxs.map(j => values[j]);

          return {
            type: "scattergeo",
            lon: tLons,
            lat: tLats,
            mode: "markers",
            marker: {
              size: 2,
              color: tValues,
              colorscale: "Viridis",
              cmin: 0,
              cmax: maxVal,
              colorbar: { title: "Aurora<br>Intensity" }
            },
            showlegend: false,
            visible: i === 0, // start with >= 0 visible
            hovertemplate:
              "Lat: %{lat}<br>" +
              "Lon: %{lon}<br>" +
              "Intensity: %{marker.color}<extra></extra>",
            name: "aurora â‰¥ " + thr
          };
        });

        const baseTitle =
          "Aurora Forecast" +
          "<br><sub>Observation: " + obsTime +
          " | Forecast: " + fcTime +
          "<br>Data: NOAA SWPC OVATION</sub>";

        const buttons = thresholds.map((thr, i) => {
          const visible = thresholds.map((_, j) => j === i);
          const bg = thrColors[thr] || "#808080";

          return {
            label: "Aurora â‰¥ " + thr,
            method: "update",
            args: [
              { visible: visible },
              {
                "title.text": baseTitle,
                "updatemenus[0].bgcolor": bg,
                "updatemenus[0].bordercolor": bg
              }
            ]
          };
        });

        const layout = {
          title: {
            text: baseTitle,
            x: 0.5,
            xanchor: "center"
          },
          geo: {
            projection: { type: "natural earth" },
            showcoastlines: true,
            coastlinecolor: "gray",
            showland: true,
            landcolor: "rgb(240,240,240)",
            showcountries: true
          },
          updatemenus: [
            {
              type: "dropdown",
              direction: "down",
              showactive: true,
              active: 0,
              x: 0.01,
              y: 1.15,
              xanchor: "left",
              yanchor: "top",
              bgcolor: thrColors[0],
              bordercolor: thrColors[0],
              buttons: buttons
            }
          ],
          margin: { l: 0, r: 0, t: 120, b: 0 },
          paper_bgcolor: "rgba(0,0,0,0)",
          plot_bgcolor: "rgba(0,0,0,0)"
        };

        await Plotly.newPlot("map", traces, layout, { responsive: true });

        // âœ… Status line + live timer
        statusEl.textContent = "Map loaded.";

        const loadedAt = new Date();

        function updateTimer() {
          const now = new Date();
          const diffMs = now - loadedAt;
          const mins = Math.floor(diffMs / 60000);
          const secs = Math.floor((diffMs % 60000) / 1000);

          let text;
          if (mins === 0 && secs < 5) {
            text = "Last updated just now";
          } else if (mins === 0) {
            text = `Last updated ${secs} seconds ago`;
          } else {
            text = `Last updated ${mins} min ${secs.toString().padStart(2, "0")} sec ago`;
          }

          timerEl.textContent = " â€¢ " + text;
        }

        updateTimer();
        setInterval(updateTimer, 15000); // refresh every 15 seconds
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Failed to load aurora data. Please try refreshing.";
      }
    }

    loadAurora();
  </script>
</body>
</html>
